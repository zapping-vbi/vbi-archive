# $Id: Makefile.in,v 1.5 2000-08-09 09:42:39 mschimek Exp $

CFLAGS	= -Wall @OPT@ @X_CFLAGS@ -g
DEFS	= -D_GNU_SOURCE -D_REENTRANT @DEFS@ -DVERSION=\"@VERSION@\"
LIBS	= @X_LIBS@ -lm -lpthread @LIBS@
OBJS	= main.o options.o rte.o convert_ry.o
MODULES = video/video.o audio/audio.o systems/systems.o common/common.o @TEST_MODULES@
TARGET  = mp1e

.PHONY: all depend clean mrproper
.EXPORT_ALL_VARIABLES:

all: configure $(OBJS)
	$(MAKE) -C video
	$(MAKE) -C audio
	$(MAKE) -C systems
	$(MAKE) -C common
	-$(MAKE) -C video/mpeg_stat
	-ln -s video/mpeg_stat/mpeg_stat stat
	-if test "@TEST_MODULES@" != ""; then $(MAKE) -C test; fi
	$(CC) $(CFLAGS) $(OBJS) $(MODULES) $(LIBS) -o $(TARGET);

%.o: %.c
	$(CC) $(CFLAGS) $(DEFS) -c $< -o $@

clean:
	-$(MAKE) clean -C audio
	-$(MAKE) clean -C video
	-$(MAKE) clean -C systems
	-$(MAKE) clean -C common
	-$(MAKE) clean -C test
	-rm $(OBJS) *.d *% *~ *.bak core log LOG $(TARGET)

mrproper: clean
	-$(MAKE) clean -C video/mpeg_stat
	-rm mp1e.lsm stat
	-$(MAKE) clean -C video/dct
	-rm Makefile video/Makefile audio/Makefile test/Makefile
	-rm Makefile systems/Makefile common/Makefile test/Makefile
	-rm config.* configure

configure: configure.in
	autoconf
	if test "@TEST_MODULES@" != ""; then ./configure --enable-test; \
	else ./configure; fi

%.d: %.c
	@echo Creating $@
	@$(SHELL) -ec '$(CC) -MM $(CFLAGS) $< \
	| sed '\''s/\($*\)\.o[ :]*/\1.o $@ : /g'\'' > $@; \
	[ -s $@ ] || rm -f $@'

-include $(OBJS:.o=.d)
